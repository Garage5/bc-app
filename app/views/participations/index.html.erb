<% stylesheet :participants %>
<% body 'participants' %>
<% title @tournament.name %>

<% content_for :tournament_nav do -%>
  <%= render :partial => "layouts/sub_nav", :locals => {:active => 'participants'} %>
<% end -%>

<div id="maincol">
	<div class="col">

  <% if current_user %>
    <% current_user.team_memberships.all(:conditions => {:state => 'pending'}).each do |memb| %>
      <% next unless memb.team.tournament_id == @tournament.id %>
   	  <div class="note blue_filled clear">
		    <p>You were invited to join the team <b><%= h memb.team.name %></b>, created by <b><%= h memb.team.captain.login %></b>.</p>
		    <a rel="modal {text: 'Do you really want to join the team?', method: 'put'}" class="btn_join" href="<%= join_tournament_team_path(@tournament, memb.team) %>">Accept</a>
		    <a rel="modal {text: 'Do you really want to decline the invitation?', method: 'delete'}" class="btn_join" href="<%= decline_tournament_team_path(@tournament, memb.team) %>">Decline</a>
	    </div><!-- / global_note -->
	  <% end %>
	<% end %>

	<% if flash[:error] %>
    <div class="note red_note global_note">
	    <p><%= flash[:error] %><a class="note-close" href="">X</a></p>
    </div>
  <% end %>
  
	<% 
	grouped = {}
	# officials
	grouped['Officials'] = [@tournament.instance.host] + @tournament.cohosts
	# without a team
  p = grouped['Participants'] = []
  p2 = grouped['Pending Approval'] = []
  for participation in @tournament.participations.all(:include => [:participant, :team_memberships])
    if (participation.team_memberships.reject{|m| m.state == 'pending'}).empty?
      if participation.state == 'pending'
        p2 << participation.participant
      elsif participation.state == 'active'
        p << participation.participant
      end
    end
  end
  # with a team
  @tournament.teams.each do |team|
    p = grouped[team.name] = []
    for participation in @tournament.participations.all(:include => [:participant, :team_memberships])
      p << participation.participant if participation.state == 'active' && !(participation.team_memberships.reject{|m| m.team_id != team.id || m.state == 'pending'}).empty?
    end
  end
	keys = ['Officials', 'Participants'] + grouped.keys.reject{|k| ['Officials', 'Participants', 'Pending Approval'].include?(k)}.sort + ['Pending Approval']
	
  keys.each do |group_name|
    group_members = grouped[group_name]
	  next if group_members.empty?
	%>
	  <div class="pod tab-pod">
		  <div class="hd">
			  <h2><%= group_name %></h2>
			  <% if group_name == 'Officials' %>
		      <% if current_user && current_user == @tournament.instance.host %>
		        <ul class="tabbed clear">
			        <li class="create_team active"><a class="rc" href="#add_cohost" rel="modal">Add a Co-Host</a></li>
		        </ul>
		      <% end %>
			  <% elsif group_name == 'Participants' %>
		      <% if current_user && current_user.is_participant_of?(@tournament) && current_user.teams_in(@tournament).empty? %>
            <ul class="tabbed clear">
	            <li class="create_team active"><a class="rc" href="#create_team" rel="modal">Create a Team</a></li>
            </ul>
          <% end %>
        <% elsif group_name == 'Pending Approval' %>
			  <% else # all the teams %>
		      <% if current_user && current_user.is_participant_of?(@tournament) && !current_user.teams_in(@tournament).empty? && current_user == current_user.teams_in(@tournament)[0].captain %>
	          <ul class="tabbed clear">
		          <li class="edit_team active"><a class="rc" href="#create_team" rel="modal">Edit Team</a></li>
		          <li class="delete_team active"><a class="rc" href="<%= tournament_team_path(@tournament, current_user.teams_in(@tournament)[0]) %>" rel="modal {method: 'delete', text: 'Do you really want to delete your team?'}">Delete Team</a></li>
	          </ul>
		      <% end %>
			  <% end %>
		  </div>
	    <div class="bd clear player_list">
	      <ul class="clear" id="list_<%= group_name.underscore %>">
	        <% group_members.each do |participant| %>
            <%= render(:partial => 'participant', :locals => {:participant => participant, :team => participant.teams_in(@tournament)[0]}) %>
	        <% end %>
		    </ul>
		    <% if group_name == 'Pending Approval' %>
					<% if current_user && current_user == @tournament.instance.host %>
          	<div class="pending_approval_btns btn_wrapper">
          	  <button class="btn" id="approve"><span class="icon"></span><span>Approve Selected</span></button>
          	  <button class="btn" id="decline"><span class="icon"></span><span>Decline Selected</span></button>
          	  <% # <a href="#deny_participation" class="btn" id="deny" rel="modal">Decline Selected</a> %>
          	</div>
					<% end %>
        <% end %>
	    </div><!-- / bd -->
	  </div><!-- / pod -->
	<% end %>
	
	<script type="text/javascript" charset="utf-8">
	  $(document).ready(function(){
	    function getPendingChecked() {
        serialized = []
        $('.approve_checkbox_box').each(function() {
          if(this.checked)
            serialized.push({name: "participant_ids[]", value: this.value});
        });
	      serialized.push({name: "authenticity_token", value: "<%= form_authenticity_token %>"});
        return serialized;
      }
	    // Approve Participants
	    $("button#approve").click(function() {
	      serialized = getPendingChecked();
	      serialized.push({name: "_method", value: "put"});
        $.post('<%= accept_tournament_participants_path(@tournament) %>', serialized, null, 'script');
      })
      
      // Deny Participants
      $("button#decline").click(function() {
	      serialized = getPendingChecked();
	      serialized.push({name: "_method", value: "delete"});
        $.post('<%= deny_tournament_participants_path(@tournament) %>', serialized, null, 'script');
      })
	  })
	</script>
	</div><!-- / col -->
</div><!-- / main-col -->
